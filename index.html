<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Pulse + BP Log (PWA)</title>
  <meta name="theme-color" content="#0b3d91" />
  <link rel="manifest" href="manifest.json" />

  <style>
    :root{
      --bg:#0b1220; --card:#121c2f; --text:#e5e7eb; --muted:#94a3b8;
      --accent:#38bdf8; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --border:rgba(148,163,184,.22); --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#070b14,#0b1220 35%,#070b14);color:var(--text)}
    header{position:sticky;top:0;background:rgba(11,18,32,.82);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);z-index:5}
    .wrap{max-width:980px;margin:0 auto;padding:14px 14px 24px}
    .title{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.2px}
    .pill{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:rgba(18,28,47,.9);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card h2{margin:0;font-size:14px;font-weight:800}
    .card .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 12px;border-bottom:1px solid var(--border)}
    .card .bd{padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{appearance:none;border:1px solid var(--border);background:#0e1730;color:var(--text);padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#0ea5e9,#0284c7);border-color:rgba(56,189,248,.45)}
    button.good{background:linear-gradient(180deg,#22c55e,#16a34a);border-color:rgba(34,197,94,.35)}
    button.warn{background:linear-gradient(180deg,#f59e0b,#d97706);border-color:rgba(245,158,11,.35)}
    button.danger{background:linear-gradient(180deg,#ef4444,#dc2626);border-color:rgba(239,68,68,.35)}
    button:disabled{opacity:.55;cursor:not-allowed}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,textarea{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:#0b1328;color:var(--text);outline:none
    }
    textarea{min-height:64px;resize:vertical}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .kpi .box{border:1px solid var(--border);border-radius:14px;padding:10px;background:rgba(11,19,40,.65)}
    .big{font-size:34px;font-weight:900;line-height:1}
    .sub{color:var(--muted);font-size:12px;margin-top:4px}
    .note{color:var(--muted);font-size:12px;line-height:1.4}
    .warnbox{border-left:4px solid var(--warn);padding:10px 12px;background:rgba(245,158,11,.08);border-radius:12px;border:1px solid rgba(245,158,11,.22)}
    .goodbox{border-left:4px solid var(--good);padding:10px 12px;background:rgba(34,197,94,.08);border-radius:12px;border:1px solid rgba(34,197,94,.22)}
    canvas{width:100%;height:120px;border-radius:14px;border:1px solid var(--border);background:rgba(11,19,40,.65)}
    /* IMPORTANT for Android camera preview */
    video{width:100%;max-height:240px;border-radius:14px;border:1px solid var(--border);background:#000;object-fit:cover}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:9px 8px;border-bottom:1px solid rgba(148,163,184,.18);vertical-align:top}
    th{color:var(--muted);font-weight:900;text-align:left}
    .right{text-align:right}
    .tiny{font-size:11px;color:var(--muted)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#0e1730;color:var(--text);font-weight:900;font-size:12px}
    .tab.active{background:rgba(56,189,248,.14);border-color:rgba(56,189,248,.45)}
    footer{margin-top:14px;color:var(--muted);font-size:12px}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted);user-select:none}
    .badge.clickable{cursor:pointer}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.red{background:var(--bad)}
    .dot.green{background:var(--good)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>

<body>
<header>
  <div class="wrap title">
    <h1>Pulse + Blood Pressure Log</h1>
    <div class="pill">v1.1 • Samsung S24</div>
  </div>
</header>

<div class="wrap">
  <div class="warnbox" style="margin-bottom:14px">
    <strong>Important:</strong> Heart-rate is an estimate. A phone alone cannot accurately measure blood pressure.
    <div class="tiny" style="margin-top:6px">
      Camera access requires <strong>HTTPS</strong> (or localhost). If you opened this as a plain file (file://) it will NOT work.
    </div>
  </div>

  <div class="grid">
    <section class="card">
      <div class="hd">
        <h2>Heart Rate (camera)</h2>
        <!-- Tap this badge to stop the camera -->
        <span class="badge clickable" id="camStatus" title="Tap to stop camera">
          <span class="dot red" id="camDot"></span><span id="camText">Camera OFF</span>
        </span>
      </div>

      <div class="bd">
        <div class="tabs" role="tablist" aria-label="Modes">
          <button class="tab active" id="tabPulse" type="button">Pulse</button>
          <button class="tab" id="tabBP" type="button">BP Log</button>
        </div>

        <div id="pulsePanel" style="margin-top:12px">
          <p class="note">
            Steps: <strong>Start camera</strong> → wait for video to appear → place fingertip over the <strong>rear camera</strong> →
            turn on <strong>flashlight</strong> if available → keep still ~30s.
          </p>

          <!-- playsinline + muted helps Android -->
          <video id="video" playsinline muted></video>

          <div class="row" style="margin-top:10px">
            <button class="primary" id="btnStart">Start camera</button>
            <button id="btnStop" disabled>Stop</button>
            <button class="warn" id="btnTorch" disabled>Flashlight: N/A</button>
            <span class="tiny" id="hint"></span>
          </div>

          <div class="kpi">
            <div class="box">
              <div class="big" id="bpm">--</div>
              <div class="sub">Beats per minute (BPM)</div>
            </div>
            <div class="box">
              <div class="big" id="quality">--</div>
              <div class="sub">Signal quality</div>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Pulse waveform (last ~10s)</label>
            <canvas id="wave" width="900" height="240"></canvas>
          </div>

          <div class="goodbox" style="margin-top:12px">
            <strong>Camera state:</strong>
            <span class="mono" id="stateLine">OFF</span>
            <div class="tiny" style="margin-top:6px" id="secureLine"></div>
          </div>
        </div>

        <div id="bpPanel" style="margin-top:12px;display:none">
          <div class="row">
            <div style="flex:1;min-width:140px">
              <label>Systolic (top)</label>
              <input id="sys" inputmode="numeric" placeholder="e.g., 120" />
            </div>
            <div style="flex:1;min-width:140px">
              <label>Diastolic (bottom)</label>
              <input id="dia" inputmode="numeric" placeholder="e.g., 80" />
            </div>
            <div style="flex:1;min-width:140px">
              <label>Pulse (optional)</label>
              <input id="pulse" inputmode="numeric" placeholder="e.g., 72" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div style="flex:1;min-width:220px">
              <label>Notes (optional)</label>
              <textarea id="notes" placeholder="e.g., morning, sitting, after exercise..."></textarea>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="good" id="btnAddBP">Add reading</button>
            <button id="btnExport">Export CSV</button>
            <button class="danger" id="btnClear" title="Deletes all BP readings">Clear all</button>
          </div>

          <div style="margin-top:12px">
            <label>Trend (last up to 30 readings)</label>
            <canvas id="bpChart" width="900" height="260"></canvas>
            <div class="tiny">Chart shows systolic (blue) and diastolic (green) lines (relative scale).</div>
          </div>

          <div style="margin-top:12px">
            <label>History</label>
            <div style="overflow:auto;border:1px solid var(--border);border-radius:14px">
              <table>
                <thead>
                  <tr>
                    <th>Date/Time</th>
                    <th>BP</th>
                    <th>Pulse</th>
                    <th>Notes</th>
                    <th class="right">Delete</th>
                  </tr>
                </thead>
                <tbody id="bpRows"></tbody>
              </table>
            </div>
          </div>

          <p class="note" style="margin-top:10px">
            BP must be measured with a cuff for accuracy. This app stores data locally on your phone.
          </p>
        </div>
      </div>
    </section>

    <aside class="card">
      <div class="hd"><h2>Why the camera might not turn on</h2></div>
      <div class="bd">
        <div class="warnbox">
          <strong>Most common causes on Samsung/Android:</strong>
          <ul class="note" style="margin:8px 0 0;padding-left:18px">
            <li>Not on <strong>HTTPS</strong> (GitHub Pages is fine). File:// won’t work.</li>
            <li>Camera permission denied for the site (Chrome settings).</li>
            <li>Another app is using the camera (close it).</li>
            <li>Opened inside an in-app browser (try Chrome directly).</li>
          </ul>
        </div>
        <p class="note" style="margin-top:10px">
          Tip: Tap the <strong>Camera badge</strong> at the top to stop the camera any time.
        </p>
        <footer>© 2026</footer>
      </div>
    </aside>
  </div>
</div>

<script>
(() => {
  "use strict";

  // ---------- Tabs ----------
  const tabPulse = document.getElementById("tabPulse");
  const tabBP = document.getElementById("tabBP");
  const pulsePanel = document.getElementById("pulsePanel");
  const bpPanel = document.getElementById("bpPanel");

  function setTab(which){
    const pulse = (which === "pulse");
    tabPulse.classList.toggle("active", pulse);
    tabBP.classList.toggle("active", !pulse);
    pulsePanel.style.display = pulse ? "block" : "none";
    bpPanel.style.display = pulse ? "none" : "block";
    if(!pulse) drawBPChart();
  }
  tabPulse.addEventListener("click", () => setTab("pulse"));
  tabBP.addEventListener("click", () => setTab("bp"));

  // ---------- Camera UI ----------
  const video = document.getElementById("video");
  const btnStart = document.getElementById("btnStart");
  const btnStop  = document.getElementById("btnStop");
  const btnTorch = document.getElementById("btnTorch");
  const bpmEl = document.getElementById("bpm");
  const qualityEl = document.getElementById("quality");
  const hintEl = document.getElementById("hint");

  const camStatus = document.getElementById("camStatus");
  const camDot = document.getElementById("camDot");
  const camText = document.getElementById("camText");
  const stateLine = document.getElementById("stateLine");
  const secureLine = document.getElementById("secureLine");

  const wave = document.getElementById("wave");
  const wctx = wave.getContext("2d", { alpha: false });

  let stream = null;
  let track = null;
  let torchOn = false;
  let rafId = null;

  // sampling buffers
  const SAMPLE_HZ = 30;
  const WINDOW_SEC = 12;
  const MAX_SAMPLES = SAMPLE_HZ * WINDOW_SEC;

  let tBuf = [];
  let vBuf = [];
  let fBuf = [];

  const c = document.createElement("canvas");
  const ctx = c.getContext("2d", { willReadFrequently: true });

  function setState(on){
    camDot.className = "dot " + (on ? "green" : "red");
    camText.textContent = on ? "Camera ON" : "Camera OFF";
    stateLine.textContent = on ? "ON" : "OFF";
  }

  function isSecureOK(){
    // secureContext true on https and localhost
    return window.isSecureContext === true;
  }

  function updateSecureLine(){
    secureLine.innerHTML = isSecureOK()
      ? "Secure context: <strong>YES</strong> (camera allowed)"
      : "Secure context: <strong>NO</strong> — use <strong>HTTPS</strong> (GitHub Pages) or localhost.";
  }
  updateSecureLine();

  async function getStreamWithFallback(){
    // Try rear camera. Some devices reject exact constraints, so use fallbacks.
    const tries = [
      { video: { facingMode: { exact: "environment" } }, audio: false },
      { video: { facingMode: { ideal: "environment" } }, audio: false },
      { video: { facingMode: "environment" }, audio: false },
      { video: true, audio: false }
    ];
    let lastErr = null;
    for(const constraints of tries){
      try{
        return await navigator.mediaDevices.getUserMedia(constraints);
      }catch(e){
        lastErr = e;
      }
    }
    throw lastErr || new Error("Unable to access camera.");
  }

  async function startCamera(){
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      throw new Error("Camera API not available in this browser.");
    }
    if(!isSecureOK()){
      throw new Error("Camera requires HTTPS (secure context).");
    }

    stream = await getStreamWithFallback();
    video.srcObject = stream;

    // Ensure Android actually starts playback
    await new Promise((resolve) => {
      video.onloadedmetadata = () => resolve();
    });

    try { await video.play(); } catch(_) { /* Some browsers autoplay-block; user already clicked Start */ }

    track = stream.getVideoTracks()[0] || null;
    setState(true);

    // Torch availability
    let caps = {};
    try { caps = track && track.getCapabilities ? track.getCapabilities() : {}; } catch(e){}
    const torchCap = !!caps.torch;
    btnTorch.disabled = !torchCap;
    btnTorch.textContent = torchCap ? "Flashlight: Off" : "Flashlight: Not supported";
    torchOn = false;
  }

  async function stopCamera(){
    if(rafId) cancelAnimationFrame(rafId);
    rafId = null;

    // turn torch off if we can
    if(track){
      try { await track.applyConstraints({ advanced: [{ torch: false }] }); } catch(_) {}
    }

    if(stream){
      stream.getTracks().forEach(t => t.stop());
    }
    stream = null;
    track = null;
    video.srcObject = null;
    setState(false);

    btnTorch.disabled = true;
    btnTorch.textContent = "Flashlight: N/A";
  }

  async function toggleTorch(){
    if(!track) return;
    try{
      await track.applyConstraints({ advanced: [{ torch: !torchOn }] });
      torchOn = !torchOn;
      btnTorch.textContent = `Flashlight: ${torchOn ? "On" : "Off"}`;
    }catch(e){
      hintEl.textContent = "Torch control failed on this camera mode.";
    }
  }
  btnTorch.addEventListener("click", toggleTorch);

  camStatus.addEventListener("click", async () => {
    if(stream){
      btnStop.disabled = true;
      await stopCamera();
      btnStart.disabled = false;
      hintEl.textContent = "Stopped.";
    }
  });

  function resetBuffers(){
    tBuf = []; vBuf = []; fBuf = [];
    bpmEl.textContent = "--";
    qualityEl.textContent = "--";
    hintEl.textContent = "";
  }

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function bandpass(samples){
    const hp = [];
    const alphaHP = 0.95;
    let y = 0, prevX = samples[0] || 0;
    for(let i=0;i<samples.length;i++){
      const x = samples[i];
      y = alphaHP * (y + x - prevX);
      hp.push(y);
      prevX = x;
    }
    const lp = [];
    const alphaLP = 0.20;
    let z = hp[0] || 0;
    for(let i=0;i<hp.length;i++){
      z = z + alphaLP * (hp[i] - z);
      lp.push(z);
    }
    return lp;
  }

  function estimateBPM(times, sig){
    if(sig.length < SAMPLE_HZ * 6) return { bpm: null, q: 0 };

    let mean = 0;
    for(const v of sig) mean += v;
    mean /= sig.length;

    let varSum = 0;
    for(const v of sig) varSum += (v-mean)*(v-mean);
    const stdev = Math.sqrt(varSum / sig.length) || 1;

    const norm = sig.map(v => (v-mean)/stdev);

    const thr = 0.35;
    const minPeakDistMs = 300;
    let peaks = [];
    let lastPeakT = -1e15;

    for(let i=2;i<norm.length-2;i++){
      const a = norm[i-1], b = norm[i], c = norm[i+1];
      if(b > thr && b > a && b > c){
        const t = times[i];
        if(t - lastPeakT >= minPeakDistMs){
          peaks.push(i);
          lastPeakT = t;
        }
      }
    }

    if(peaks.length < 4) return { bpm: null, q: clamp(peaks.length/6, 0, 1) };

    const intervals = [];
    for(let j=1;j<peaks.length;j++){
      const dt = times[peaks[j]] - times[peaks[j-1]];
      if(dt > 300 && dt < 1500) intervals.push(dt);
    }
    if(intervals.length < 3) return { bpm: null, q: clamp(intervals.length/6, 0, 1) };

    intervals.sort((a,b)=>a-b);
    const mid = Math.floor(intervals.length/2);
    const med = intervals.length % 2 ? intervals[mid] : (intervals[mid-1]+intervals[mid])/2;

    const bpm = 60000 / med;

    let spread = 0;
    for(const dt of intervals) spread += Math.abs(dt - med);
    spread /= intervals.length;
    const consistency = clamp(1 - (spread / med), 0, 1);
    const amplitude = clamp(stdev / 1.8, 0, 1);
    const q = clamp(0.55*consistency + 0.45*amplitude, 0, 1);

    return { bpm, q };
  }

  function drawWave(sig){
    const W = wave.width, H = wave.height;
    wctx.fillStyle = "#0b1328";
    wctx.fillRect(0,0,W,H);

    wctx.globalAlpha = 0.45;
    wctx.strokeStyle = "rgba(148,163,184,.22)";
    wctx.lineWidth = 1;
    for(let x=0;x<=W;x+=W/6){
      wctx.beginPath(); wctx.moveTo(x,0); wctx.lineTo(x,H); wctx.stroke();
    }
    for(let y=0;y<=H;y+=H/4){
      wctx.beginPath(); wctx.moveTo(0,y); wctx.lineTo(W,y); wctx.stroke();
    }
    wctx.globalAlpha = 1;

    if(sig.length < 5) return;

    let min = Infinity, max = -Infinity;
    for(const v of sig){ if(v<min) min=v; if(v>max) max=v; }
    const range = (max-min) || 1;

    wctx.strokeStyle = "rgba(56,189,248,.95)";
    wctx.lineWidth = 3;
    wctx.beginPath();
    for(let i=0;i<sig.length;i++){
      const x = (i/(sig.length-1)) * (W-2) + 1;
      const y = H - ( (sig[i]-min)/range * (H-20) + 10 );
      if(i===0) wctx.moveTo(x,y); else wctx.lineTo(x,y);
    }
    wctx.stroke();
  }

  function sampleFrame(){
    if(!stream || !track){
      return;
    }
    if(!video.videoWidth || !video.videoHeight) {
      rafId = requestAnimationFrame(sampleFrame);
      return;
    }

    const vw = video.videoWidth, vh = video.videoHeight;
    c.width = vw; c.height = vh;
    ctx.drawImage(video, 0, 0, vw, vh);

    const size = Math.floor(Math.min(vw, vh) * 0.22);
    const rx = Math.floor(vw/2 - size/2);
    const ry = Math.floor(vh/2 - size/2);

    const img = ctx.getImageData(rx, ry, size, size).data;

    let r = 0;
    for(let i=0;i<img.length;i+=4) r += img[i];
    const ravg = r / (img.length/4);

    const now = performance.now();

    tBuf.push(now);
    vBuf.push(ravg);

    if(tBuf.length > MAX_SAMPLES){
      tBuf.shift(); vBuf.shift();
    }

    fBuf = bandpass(vBuf);

    const { bpm, q } = estimateBPM(tBuf, fBuf);
    if(bpm && bpm >= 40 && bpm <= 200){
      bpmEl.textContent = Math.round(bpm).toString();
    }else{
      bpmEl.textContent = "--";
    }
    const qPct = Math.round(q * 100);
    qualityEl.textContent = (qPct ? (qPct + "%") : "--");

    if(q < 0.35){
      hintEl.textContent = "Low signal: keep still, cover lens fully, try torch.";
    }else if(q < 0.65){
      hintEl.textContent = "OK signal: hold steady a bit longer…";
    }else{
      hintEl.textContent = "Good signal.";
    }

    const tenSec = 10000;
    const cutIndex = (() => {
      const t0 = now - tenSec;
      for(let i=0;i<tBuf.length;i++) if(tBuf[i] >= t0) return i;
      return 0;
    })();
    drawWave(fBuf.slice(cutIndex));

    rafId = requestAnimationFrame(sampleFrame);
  }

  btnStart.addEventListener("click", async () => {
    btnStart.disabled = true;
    hintEl.textContent = "Starting camera…";

    try{
      resetBuffers();
      await startCamera();
      btnStop.disabled = false;
      hintEl.textContent = "Camera on. Wait for video, then place finger gently.";
      rafId = requestAnimationFrame(sampleFrame);
    }catch(e){
      const msg = (e && e.name)
        ? `${e.name}: ${e.message || ""}`.trim()
        : (e && e.message) ? e.message : String(e);

      setState(false);
      btnStart.disabled = false;
      btnStop.disabled = true;
      hintEl.textContent =
        "Camera failed. Common fix: use HTTPS + allow camera permission. Error: " + msg;
    }
  });

  btnStop.addEventListener("click", async () => {
    btnStop.disabled = true;
    await stopCamera();
    btnStart.disabled = false;
    hintEl.textContent = "Stopped.";
  });

  document.addEventListener("visibilitychange", () => {
    if(document.hidden && stream){
      stopCamera();
      btnStop.disabled = true;
      btnStart.disabled = false;
    }
  });

  // ---------- BP Log ----------
  const KEY = "pulse_bp_log_v1_1";
  const sysEl = document.getElementById("sys");
  const diaEl = document.getElementById("dia");
  const pulseLogEl = document.getElementById("pulse");
  const notesEl = document.getElementById("notes");
  const btnAddBP = document.getElementById("btnAddBP");
  const btnExport = document.getElementById("btnExport");
  const btnClear = document.getElementById("btnClear");
  const bpRows = document.getElementById("bpRows");

  const bpChart = document.getElementById("bpChart");
  const bctx = bpChart.getContext("2d", { alpha: false });

  function loadBP(){
    try{
      const raw = localStorage.getItem(KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function saveBP(arr){
    localStorage.setItem(KEY, JSON.stringify(arr));
  }
  function fmtDate(ts){
    const d = new Date(ts);
    return d.toLocaleString();
  }

  function renderBP(){
    const arr = loadBP().sort((a,b)=>b.ts-a.ts);
    bpRows.innerHTML = "";
    for(const r of arr){
      const tr = document.createElement("tr");
      const bpStr = `${r.sys}/${r.dia}`;
      tr.innerHTML = `
        <td>${fmtDate(r.ts)}<div class="tiny">${r.source || ""}</div></td>
        <td><strong>${bpStr}</strong></td>
        <td>${r.pulse ? r.pulse : ""}</td>
        <td>${(r.notes||"").replaceAll("<","&lt;")}</td>
        <td class="right"><button class="danger" data-del="${r.id}">X</button></td>
      `;
      bpRows.appendChild(tr);
    }
    bpRows.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-del");
        const next = loadBP().filter(x => x.id !== id);
        saveBP(next);
        renderBP();
        drawBPChart();
      });
    });
  }

  function drawBPChart(){
    const arr = loadBP().sort((a,b)=>a.ts-b.ts).slice(-30);
    const W = bpChart.width, H = bpChart.height;

    bctx.fillStyle = "#0b1328";
    bctx.fillRect(0,0,W,H);

    bctx.globalAlpha = 0.45;
    bctx.strokeStyle = "rgba(148,163,184,.22)";
    bctx.lineWidth = 1;
    for(let x=0;x<=W;x+=W/6){ bctx.beginPath(); bctx.moveTo(x,0); bctx.lineTo(x,H); bctx.stroke(); }
    for(let y=0;y<=H;y+=H/4){ bctx.beginPath(); bctx.moveTo(0,y); bctx.lineTo(W,y); bctx.stroke(); }
    bctx.globalAlpha = 1;

    if(arr.length < 2){
      bctx.fillStyle = "rgba(148,163,184,.75)";
      bctx.font = "16px system-ui";
      bctx.fillText("Add BP readings to see a trend chart.", 14, 32);
      return;
    }

    const sys = arr.map(r=>r.sys);
    const dia = arr.map(r=>r.dia);

    const minV = Math.min(...dia, ...sys) - 5;
    const maxV = Math.max(...dia, ...sys) + 5;
    const range = (maxV - minV) || 1;

    function yFor(v){
      return H - ( (v - minV) / range * (H-30) + 15 );
    }
    function drawLine(vals, stroke){
      bctx.strokeStyle = stroke;
      bctx.lineWidth = 3;
      bctx.beginPath();
      for(let i=0;i<vals.length;i++){
        const x = (i/(vals.length-1))*(W-30)+15;
        const y = yFor(vals[i]);
        if(i===0) bctx.moveTo(x,y); else bctx.lineTo(x,y);
      }
      bctx.stroke();
    }

    drawLine(sys, "rgba(56,189,248,.95)");
    drawLine(dia, "rgba(34,197,94,.85)");

    bctx.fillStyle = "rgba(229,231,235,.9)";
    bctx.font = "14px system-ui";
    bctx.fillText("Systolic", 16, 22);
    bctx.fillText("Diastolic", 94, 22);

    bctx.fillStyle = "rgba(148,163,184,.85)";
    bctx.font = "12px system-ui";
    bctx.fillText(`Scale: ${Math.round(minV)}–${Math.round(maxV)} mmHg (relative)`, 16, H-10);
  }

  function toInt(el){
    const n = parseInt((el.value||"").trim(), 10);
    return Number.isFinite(n) ? n : null;
  }

  btnAddBP.addEventListener("click", () => {
    const sys = toInt(sysEl);
    const dia = toInt(diaEl);
    const pulse = toInt(pulseLogEl);

    if(sys === null || dia === null || sys < 60 || sys > 260 || dia < 30 || dia > 160){
      alert("Please enter a valid BP reading (example 120 / 80).");
      return;
    }
    const rec = {
      id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
      ts: Date.now(),
      sys, dia,
      pulse: (pulse !== null && pulse >= 30 && pulse <= 220) ? pulse : null,
      notes: (notesEl.value || "").trim().slice(0, 500),
      source: "Manual"
    };
    const arr = loadBP();
    arr.push(rec);
    saveBP(arr);

    sysEl.value = ""; diaEl.value = ""; pulseLogEl.value = "";
    renderBP();
    drawBPChart();
  });

  btnExport.addEventListener("click", () => {
    const arr = loadBP().sort((a,b)=>a.ts-b.ts);
    if(!arr.length){ alert("No BP readings to export."); return; }
    const header = ["timestamp","date_time","systolic","diastolic","pulse","notes"];
    const lines = [header.join(",")];
    for(const r of arr){
      const dt = new Date(r.ts).toISOString();
      const safeNotes = (r.notes||"").replaceAll('"','""').replaceAll("\n"," ");
      lines.push([r.ts, dt, r.sys, r.dia, (r.pulse||""), `"${safeNotes}"`].join(","));
    }
    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "bp-readings.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  btnClear.addEventListener("click", () => {
    if(confirm("Delete ALL BP readings stored on this phone for this app?")){
      localStorage.removeItem(KEY);
      renderBP();
      drawBPChart();
    }
  });

  // initial
  setState(false);
  renderBP();
  drawBPChart();

  // PWA service worker (optional; keep your service-worker.js file)
  if("serviceWorker" in navigator){
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    });
  }

})();
</script>
</body>
</html>